From 275c6898b0c568af56c79576f141833ea04c541e Mon Sep 17 00:00:00 2001
From: BattleDash <itsbattledash@gmail.com>
Date: Fri, 15 Jan 2021 02:36:45 -0700
Subject: [PATCH] Fix chunks not being sent to clients when being repeatedly
 teleported


diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index 2770441b..30bbaa5e 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -7,144 +7,7 @@ import java.util.List;
 import java.util.Set;
 import java.util.UUID;
 import net.md_5.bungee.api.chat.BaseComponent;
-import net.minecraft.server.AxisAlignedBB;
-import net.minecraft.server.BlockPosition;
-import net.minecraft.server.DamageSource;
-import net.minecraft.server.Entity;
-import net.minecraft.server.EntityAmbient;
-import net.minecraft.server.EntityAnimal;
-import net.minecraft.server.EntityAreaEffectCloud;
-import net.minecraft.server.EntityArmorStand;
-import net.minecraft.server.EntityArrow;
-import net.minecraft.server.EntityBat;
-import net.minecraft.server.EntityBee;
-import net.minecraft.server.EntityBlaze;
-import net.minecraft.server.EntityBoat;
-import net.minecraft.server.EntityCat;
-import net.minecraft.server.EntityCaveSpider;
-import net.minecraft.server.EntityChicken;
-import net.minecraft.server.EntityCod;
-import net.minecraft.server.EntityComplexPart;
-import net.minecraft.server.EntityCow;
-import net.minecraft.server.EntityCreature;
-import net.minecraft.server.EntityCreeper;
-import net.minecraft.server.EntityDolphin;
-import net.minecraft.server.EntityDragonFireball;
-import net.minecraft.server.EntityDrowned;
-import net.minecraft.server.EntityEgg;
-import net.minecraft.server.EntityEnderCrystal;
-import net.minecraft.server.EntityEnderDragon;
-import net.minecraft.server.EntityEnderPearl;
-import net.minecraft.server.EntityEnderSignal;
-import net.minecraft.server.EntityEnderman;
-import net.minecraft.server.EntityEndermite;
-import net.minecraft.server.EntityEvoker;
-import net.minecraft.server.EntityEvokerFangs;
-import net.minecraft.server.EntityExperienceOrb;
-import net.minecraft.server.EntityFallingBlock;
-import net.minecraft.server.EntityFireball;
-import net.minecraft.server.EntityFireworks;
-import net.minecraft.server.EntityFish;
-import net.minecraft.server.EntityFishingHook;
-import net.minecraft.server.EntityFlying;
-import net.minecraft.server.EntityFox;
-import net.minecraft.server.EntityGhast;
-import net.minecraft.server.EntityGiantZombie;
-import net.minecraft.server.EntityGolem;
-import net.minecraft.server.EntityGuardian;
-import net.minecraft.server.EntityGuardianElder;
-import net.minecraft.server.EntityHanging;
-import net.minecraft.server.EntityHoglin;
-import net.minecraft.server.EntityHorse;
-import net.minecraft.server.EntityHorseAbstract;
-import net.minecraft.server.EntityHorseChestedAbstract;
-import net.minecraft.server.EntityHorseDonkey;
-import net.minecraft.server.EntityHorseMule;
-import net.minecraft.server.EntityHorseSkeleton;
-import net.minecraft.server.EntityHorseZombie;
-import net.minecraft.server.EntityHuman;
-import net.minecraft.server.EntityIllagerAbstract;
-import net.minecraft.server.EntityIllagerIllusioner;
-import net.minecraft.server.EntityIllagerWizard;
-import net.minecraft.server.EntityIronGolem;
-import net.minecraft.server.EntityItem;
-import net.minecraft.server.EntityItemFrame;
-import net.minecraft.server.EntityLargeFireball;
-import net.minecraft.server.EntityLeash;
-import net.minecraft.server.EntityLightning;
-import net.minecraft.server.EntityLiving;
-import net.minecraft.server.EntityLlama;
-import net.minecraft.server.EntityLlamaSpit;
-import net.minecraft.server.EntityLlamaTrader;
-import net.minecraft.server.EntityMagmaCube;
-import net.minecraft.server.EntityMinecartAbstract;
-import net.minecraft.server.EntityMinecartChest;
-import net.minecraft.server.EntityMinecartCommandBlock;
-import net.minecraft.server.EntityMinecartFurnace;
-import net.minecraft.server.EntityMinecartHopper;
-import net.minecraft.server.EntityMinecartMobSpawner;
-import net.minecraft.server.EntityMinecartRideable;
-import net.minecraft.server.EntityMinecartTNT;
-import net.minecraft.server.EntityMonster;
-import net.minecraft.server.EntityMushroomCow;
-import net.minecraft.server.EntityOcelot;
-import net.minecraft.server.EntityPainting;
-import net.minecraft.server.EntityPanda;
-import net.minecraft.server.EntityParrot;
-import net.minecraft.server.EntityPhantom;
-import net.minecraft.server.EntityPig;
-import net.minecraft.server.EntityPigZombie;
-import net.minecraft.server.EntityPiglin;
-import net.minecraft.server.EntityPiglinAbstract;
-import net.minecraft.server.EntityPiglinBrute;
-import net.minecraft.server.EntityPillager;
-import net.minecraft.server.EntityPlayer;
-import net.minecraft.server.EntityPolarBear;
-import net.minecraft.server.EntityPotion;
-import net.minecraft.server.EntityProjectile;
-import net.minecraft.server.EntityPufferFish;
-import net.minecraft.server.EntityRabbit;
-import net.minecraft.server.EntityRavager;
-import net.minecraft.server.EntitySalmon;
-import net.minecraft.server.EntitySheep;
-import net.minecraft.server.EntityShulker;
-import net.minecraft.server.EntityShulkerBullet;
-import net.minecraft.server.EntitySilverfish;
-import net.minecraft.server.EntitySkeletonAbstract;
-import net.minecraft.server.EntitySkeletonStray;
-import net.minecraft.server.EntitySkeletonWither;
-import net.minecraft.server.EntitySlime;
-import net.minecraft.server.EntitySmallFireball;
-import net.minecraft.server.EntitySnowball;
-import net.minecraft.server.EntitySnowman;
-import net.minecraft.server.EntitySpectralArrow;
-import net.minecraft.server.EntitySpider;
-import net.minecraft.server.EntitySquid;
-import net.minecraft.server.EntityStrider;
-import net.minecraft.server.EntityTNTPrimed;
-import net.minecraft.server.EntityTameableAnimal;
-import net.minecraft.server.EntityThrownExpBottle;
-import net.minecraft.server.EntityThrownTrident;
-import net.minecraft.server.EntityTippedArrow;
-import net.minecraft.server.EntityTropicalFish;
-import net.minecraft.server.EntityTurtle;
-import net.minecraft.server.EntityVex;
-import net.minecraft.server.EntityVillager;
-import net.minecraft.server.EntityVillagerAbstract;
-import net.minecraft.server.EntityVillagerTrader;
-import net.minecraft.server.EntityVindicator;
-import net.minecraft.server.EntityWaterAnimal;
-import net.minecraft.server.EntityWitch;
-import net.minecraft.server.EntityWither;
-import net.minecraft.server.EntityWitherSkull;
-import net.minecraft.server.EntityWolf;
-import net.minecraft.server.EntityZoglin;
-import net.minecraft.server.EntityZombie;
-import net.minecraft.server.EntityZombieHusk;
-import net.minecraft.server.EntityZombieVillager;
-import net.minecraft.server.IChatBaseComponent;
-import net.minecraft.server.NBTBase;
-import net.minecraft.server.NBTTagCompound;
+import net.minecraft.server.*;
 import org.bukkit.EntityEffect;
 import org.bukkit.Location;
 import org.bukkit.Server;
@@ -499,6 +362,11 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         entity.setHeadRotation(location.getYaw());
         ((net.minecraft.server.WorldServer) entity.world).chunkCheck(entity); // Spigot - register to new chunk
 
+        // Fixes chunks not being sent to clients when being repeatedly teleported
+        if (entity instanceof EntityPlayer) {
+            ((net.minecraft.server.WorldServer) entity.world).getChunkProvider().playerChunkMap.movePlayer((EntityPlayer) entity);
+        }
+
         return true;
     }
 
-- 
2.22.0.windows.1

