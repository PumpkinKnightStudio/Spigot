From 133f3085301c15515c741cb1228a0b781c81c8bb Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Sat, 3 Jan 2015 02:06:56 -0500
Subject: [PATCH] Configurable Keep Spawn Loaded range per world

This lets you disable it for some worlds and lower it for others.
It also bounds it to the view-distance, to not load more than needed like it currently does.

diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 2079772..175f365 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -356,8 +356,9 @@ public abstract class MinecraftServer implements Runnable, ICommandListener, IAs
             long j = az();
             i = 0;
 
-            for (int k = -192; k <= 192 && this.isRunning(); k += 16) {
-                for (int l = -192; l <= 192 && this.isRunning(); l += 16) {
+            short radius = worldserver.spigotConfig.keepLoadedRange; // Spigot
+            for (int k = -radius; k <= radius && this.isRunning(); k += 16) { // Spigot
+                for (int l = -radius; l <= radius && this.isRunning(); l += 16) { // Spigot
                     long i1 = az();
 
                     if (i1 - j > 1000L) {
diff --git a/src/main/java/net/minecraft/server/World.java b/src/main/java/net/minecraft/server/World.java
index 0271b19..4ef28a4 100644
--- a/src/main/java/net/minecraft/server/World.java
+++ b/src/main/java/net/minecraft/server/World.java
@@ -3113,7 +3113,7 @@ public abstract class World implements IBlockAccess {
         BlockPosition blockposition = this.getSpawn();
         int k = i * 16 + 8 - blockposition.getX();
         int l = j * 16 + 8 - blockposition.getZ();
-        short short0 = 128;
+        short short0 = spigotConfig.keepLoadedRange; // Spigot
 
         return k >= -short0 && k <= short0 && l >= -short0 && l <= short0 && this.keepSpawnInMemory; // CraftBukkit - Added 'this.keepSpawnInMemory'
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index f57c785..e067288 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -907,7 +907,7 @@ public final class CraftServer implements Server {
         System.out.print("Preparing start region for level " + (console.worlds.size() - 1) + " (Seed: " + internal.getSeed() + ")");
 
         if (internal.getWorld().getKeepSpawnInMemory()) {
-            short short1 = 196;
+            short short1 = internal.spigotConfig.keepLoadedRange; // Spigot
             long i = System.currentTimeMillis();
             for (int j = -short1; j <= short1; j += 16) {
                 for (int k = -short1; k <= short1; k += 16) {
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
index 17f2c0a..d63eb7c 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
@@ -1171,8 +1171,9 @@ public class CraftWorld implements World {
         int chunkCoordX = chunkcoordinates.getX() >> 4;
         int chunkCoordZ = chunkcoordinates.getZ() >> 4;
         // Cycle through the 25x25 Chunks around it to load/unload the chunks.
-        for (int x = -12; x <= 12; x++) {
-            for (int z = -12; z <= 12; z++) {
+        int radius = world.spigotConfig.keepLoadedRange / 16; // Spigot
+        for (int x = -radius; x <= radius; x++) { // Spigot
+            for (int z = -radius; z <= radius; z++) { // Spigot
                 if (keepLoaded) {
                     loadChunk(chunkCoordX + x, chunkCoordZ + z);
                 } else {
diff --git a/src/main/java/org/spigotmc/SpigotWorldConfig.java b/src/main/java/org/spigotmc/SpigotWorldConfig.java
index 8e86212..0ab60e0 100644
--- a/src/main/java/org/spigotmc/SpigotWorldConfig.java
+++ b/src/main/java/org/spigotmc/SpigotWorldConfig.java
@@ -129,10 +129,14 @@ public class SpigotWorldConfig
     }
 
     public int viewDistance;
+    public short keepLoadedRange;
     private void viewDistance()
     {
         viewDistance = getInt( "view-distance", Bukkit.getViewDistance() );
         log( "View Distance: " + viewDistance );
+
+        keepLoadedRange = (short) ( Math.min( getInt( "keep-spawn-loaded-range", viewDistance ), viewDistance ) * 16 );
+        log( "Keep Spawn Loaded Range: " + ( keepLoadedRange / 16 ) );
     }
 
     public byte mobSpawnRange;
-- 
2.6.1

